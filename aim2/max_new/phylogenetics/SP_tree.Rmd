---
title: "phylogenetics"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(phangorn) 
library(ape)
#install ggtree
#source("https://bioconductor.org/biocLite.R")
#biocLite("ggtree")
library(ggplot2)
library(ggtree)
library(stringr)
```

```{r}

#read in the meta data
meta_data3 <- read_tsv("meta_data3.tsv", col_names = TRUE)
names(meta_data3) <- c("Sequence", "Sequence_ID", "Notes", "Species")

#read in the tree
sp_tree4 <- read.tree("SP_tree4.fasta.contree")

#replace the : with - and the | with _ in the sequence names in meta data to match it to the tree tip labels/sequence names (which were altered along the way - perhaps in iqtree)
meta_data3_reformatted <- meta_data3$Sequence %>% stringr::str_replace_all(c(":"="_","\\|"="_")) 

#match the tip labels with the freshly formatted sequence names
tip_label_order2 <- match(sp_tree4$tip.label,meta_data3_reformatted)

# Check tip_label_order
if ( ! identical(meta_data3_reformatted[tip_label_order2],sp_tree4$tip.label) ){
  cat("Error tip label order not correct")
  stop()
} else {
  #assign the tip labels to use the Sequence_ID column from the meta_data file
  sp_tree4$tip.label <- meta_data3$Sequence_ID[tip_label_order2]
}

#midpoint root the tree
sp_tree4 <- midpoint(sp_tree4)

# Assign clades by parsing the tip labels and using split to create corresponding groups
# This is safer and cleaner than hard coding names
#
clades <- sp_tree4$tip.label %>% 
  str_extract("[^_]+") %>% 
  str_replace_all(c("Dm"="Drosophila melanogaster",
                             "Ob"="Octopus bimaculoides",
                             "Cg"="Crassostrea gigas",
                             "Ov"="Octopus vulgaris",
                             "Ok"="Octopus kaurna",
                             "Hm"="Hapalochlaena maculosa",
                             "So"="Sepia officinalis"))
clade_groups <- split(sp_tree4$tip.label,clades)

#assign the list to the tree
sp_tree4 <- groupOTU(sp_tree4, clade_groups)

#change the original attribute levels of the species names to reverse them for the legend
#attr(sp_tree4,'group') <-  factor(attr(sp_tree4,'group'),levels=rev(levels(attr(sp_tree4,'group'))))

# First make a rough plot of the tree so we can visualise the node numbers.  This allows us to select nodes for collapse
nodes_tree <- ggtree(sp_tree4, aes(color=group, linetype=group)) + 
  geom_tiplab(size=2) + 
  geom_text2(aes(label=node), hjust=-.1, size=2) +  
  geom_treescale(offset = 1) + 
  theme(legend.position=c(0.1,0.8), legend.text = element_text(face = "italic"), legend.title = element_blank()) + 
  xlim(-1,5) 
ggsave(nodes_tree, filename = "sp_tree4_nodes.png", width = 210, height = 297, units = "mm")




#construct the tree colouring in by species, depicting bootstrap values (node support) with slight adjustments to the size and position to make the tree clearer, add a scale for the tree, add the legend and alter its position, italicise the legend and remove the legend title
tree_graphic <- ggtree(sp_tree4, aes(color=group, linetype=group)) + 
  geom_tiplab(size=2) + 
  geom_text2(aes(subset = !isTip, label=label), hjust=-.1, size=2) + 
  geom_treescale(offset = 1) + 
  theme(legend.position=c(0.1,0.8), legend.text = element_text(face = "italic"), legend.title = element_blank()) + 
  xlim(-0.5,4) 

# Collapse well supported Drosophila clades  
tg <- collapse(tree_graphic,node=c(220)) %>% collapse(node=193)
tg <- tg + geom_point2(aes(subset=(node %in% c(220,193))), size=5, shape=".") 

#save the tree using a4 dimensions
ggsave(tg, filename = "sp_tree4.png", width = 210, height = 297, units = "mm")
```